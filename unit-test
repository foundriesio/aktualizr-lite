#!/bin/bash -e

here=$(dirname $(readlink -f $0))
cd $here

if [ $# -eq 0 ] ; then
	echo "Launching unit tests in docker"
	TEST=1 exec ./dev-shell sudo -u testuser ./unit-test indocker
fi

set -x

build=$(mktemp -d)
install=$(mktemp -d)

export CC=clang
export CXX=clang++

echo "## Compiling aklite"
cmake -S . -B $build -DCMAKE_INSTALL_PREFIX=install -DCMAKE_BUILD_TYPE=Debug -GNinja -DBUILD_P11=ON
cmake --build $build --target aklite-tests

echo "## Running aklite unit tests"
cd $build
ctest -j6 -L aklite --output-on-failure
cd $here
rm -rf $build
